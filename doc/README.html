<!DOCTYPE html>
<html>
<head>
<title>README</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h1>本番端末室内オラクルシェル利用ガイド</h1>

<hr />

<h2>画面イメージ</h2>

<p><img src="images/full1.jpg" alt="イメージ" />
<img src="images/full2.jpg" alt="イメージ" /></p>

<hr />

<ol>
<li>接続選択コンポボックス</li>
<li>認証プロキシのログインユーザ<br />
<em>ログオフ状態の場合、入力可能</em></li>
<li>認証プロキシのログインパスワード<br />
<em>ログオフ状態の場合、入力可能</em></li>
<li>Connect/Disconnectボタン</li>
<li>特殊SQL発行チェックボックス。<br />
ここをチェックすると、SQLを整形、チェックしないままでサーバに送る。</li>
<li>実行タイムアウト設定テキストボックス</li>
<li>SQL発行ボタン</li>
<li>SQLフォーマットボタン</li>
<li>SQLアシスタントボックス</li>
<li>テーブル一覧のテーブル名</li>
<li>共通事前定義SQL</li>
<li>個人事前定義SQL</li>
<li>SQL編集テキストボックス</li>
<li>SQL実行結果ボックス</li>
<li>SQL実行結果保存ボタン</li>
<li>SQL実行ログコンソール</li>
<li>SQL実行ログ出力チェック</li>
<li>SQL実行ログ追跡チェック</li>
<li>SQL実行ログクリアボタン</li>
<li>維持ログ行数コンポボックス</li>
<li>ログ保存ボタン</li>
</ol>

<h2>画面操作</h2>

<h3>ログイン</h3>

<p><img src="images/logon.jpg" alt="logon" /></p>

<hr />

<ol>
<li>接続操作
<ol>
<li>「1. 接続選択コンポボックス」で接続先環境を選択する。</li>
<li>「2. 認証プロキシのログインユーザ」で認証プロキシのユーザIDを入力する。</li>
<li>「3. 認証プロキシのログインパスワード」で認証プロキシのパスワードを入力する。</li>
<li>「4. Connect/Disconnectボタン」をクリップして、事前定義したスクリプトでログインを
を行う。</li>
</ol></li>
<li>接続成功した結果
<img src="images/logon_ok.jpg" alt="logon_ok" />
<ol>
<li>エラーが報告されない。</li>
<li>テーブル一覧、共通SQL定義、個人SQL定義が表示される。</li>
<li>「2. 認証プロキシのログインユーザ」と「3. 認証プロキシのログインパスワード」
が入力不可になる。</li>
</ol></li>
<li>接続失敗した結果
<img src="images/logon_ng.jpg" alt="logon_ng" />
<ol>
<li>エラーメッセージボックスが確認される。</li>
</ol></li>
</ol>

<h3>SQL編集作業</h3>

<ol>
<li>「9. SQLアシスタントボックス」で直接SQL入力できる。</li>
<li>「10. テーブル一覧のテーブル名」、「11. 共通事前定義SQL」、「12. 個人事前定義SQL」で対象テーブル名かSQL名を
ダブルクリップして、事前定義SQLが「9. SQLアシスタントボックス」に入れられる。</li>
<li>「9. SQLアシスタントボックス」の「共通SQL定義」か「個人SQL定義」に右クリックすると、
「13. SQL編集テキストボックス」の内容を事前定義SQLとして登録できる。</li>
<li>「11. 共通事前定義SQL」か「12. 個人事前定義SQL」を右クリックすると、「13. SQL編集テキストボックス」の内容で
事前定義SQLを更新出来る。また、削除も出来る。</li>
<li>「8. SQLフォーマットボタン」ボタンをクリックすると、「13. SQL編集テキストボックス」の内容を整形される。</li>
<li><p>SQLテキストで最初からの"+ "で始まる行はフォーマット文字として認識し、そのままサーバに転送される。<br />
▼<em>サンプル</em></p>

<pre><code> + column LOGIN_ID format a50  
 select
     'aaa' as LOGIN_ID  
 from
     dual
</code></pre></li>
</ol>

<h3>SQL実行作業</h3>

<ol>
<li>基本的に「7. SQL発行ボタン」をクリックして、「13. SQL編集テキストボックス」の内容を整形し、サーバに送って実行する。</li>
<li><p>チェック・整形ルール</p>

<ol>
<li><code>&amp;変数名</code> が見つかった場合、変数入れ替えダイアログを表示し、入力した変数値でSQLを入れ替えする。</li>
<li>改行コード（0x0d,0x0a）がある場合、改行コードをスペースに変える。  </li>
<li><code>INSERT|DELETE|UPDATE|PURGE|DROP|ALTER|EXECUTE|CREATE|TRUNCATE|COMMIT|BEGIN|END</code>がSQLに存在するかを
チェック、存在する場合、警告メッセージを表示し、実行を諦める。</li>
<li>SQLは<code>;</code>で終了する場合、<code>;</code>を削除する。</li>
<li>SQL前後のスペースを削除する。</li>
<li><p>SQLは<code>select *</code>で始まる場合、下記のように変更する。</p>

<pre><code>select '########' as \"%%%%%%%%\", t_t_t_t_t_t_t_t.* from (元のSQL) t_t_t_t_t_t_t_t
</code></pre></li>
<li><p>SQLは<code>select</code>で始まる場合、下記のように変更する。</p>

<pre><code>select '########' as \"%%%%%%%%\"," + 元のSQLでselectを抜いた部分
</code></pre></li>
<li>SQLは<code>select</code>で始まってない場合、エラーとして、警告メッセージを表示し、、実行を諦める。</li>
</ol>

<p>※「5.  特殊SQL発行チェックボックス」がチェックされた場合、「2.」からのチェックが発生しない。</p></li>
<li><p>タイムアウトについて</p>

<ol>
<li><p>SQL実行タイムアウト</p>

<p>大量データを出力されるSQLが実行される場合、長時間大量なネット通信で障害に及ぶことが考えられるので、
SQLが発行されてから実行終了までタイムアウトが設定される。</p>

<ul>
<li>タイムアウトが発生した場合、SQLPLUSに対して<code>[CTRL]+C</code>が送られる。</li>
<li>メッセージボックスでタイムアウトが発生することを通知する。</li>
<li>タイムアウト時間は「6.  実行タイムアウト設定テキストボックス」で設定する。
デフォールト値があるが、自由に変えられる。</li>
</ul></li>
<li><p>ログインタイムアウト</p>

<p>セキュリティの理由で、DBに接続して、長時間で操作しないと、自動ログアウトする。</p>

<ul>
<li>「操作しない」の意味はすべてのコントロールにマウス移動しない、キーボードのキーを押さないことを意味する。</li>
<li>タイムアウト時間は定義ファイルで定義される。</li>
</ul></li>
</ol></li>
</ol>

<h3>項目名表示について</h3>

<p>SQL文が実行され、「14. SQL実行結果ボックス」に結果を表示されるが、列名はSQL文発行されたままになる。
SQL文で取得したコラム名を自動に人間に読みやすい形に変換することでユーザに役立つ。</p>

<ol>
<li><p>自動変換ファイルについて、下記のパスにおかれる。<br />
<code>ソフトインストールパス\fieldname.csv</code></p>

<p>フォーマットは　<code>SQLコラム名,表示用コラム名</code>　である。<br />
▼<em>サンプル</em></p>

<pre><code>TUSK,証券会社コード
LOGIN_ID,ログインID
</code></pre></li>
<li><p>コラムサイズについて</p>

<p>本ツールのバックグランドはSQLPLUSですので、SQLPLUSが実データの表示幅にあわせ、コラムタイトルを一部消すことがある。
これを回避するため、コラムサイズを強制指定できる。</p>

<p>▼<em>サンプル</em></p>

<pre><code>select
    'aaa' as LOGIN_ID  
from
    dual
</code></pre>

<p>コラムLOGIN_IDは8文字分が必要、データ<code>'aaa'</code>は3文字のみ、通常、下記のような結果になる。<br />
 <img src="images/column_sample_01.jpg" alt="sample1" /></p>

<p>▼<em>サンプル</em></p>

<pre><code>+ column LOGIN_ID format a8  
select
    'aaa' as LOGIN_ID  
from
    dual
</code></pre>

<p>コラムLOGIN_IDのサイズを8文字に固定して、日本語<code>ログインID</code>に変換される。
<img src="images/column_sample_02.jpg" alt="sample1" /></p></li>
</ol>

<h2>設定</h2>

<h3>サーバとの対話手続きについて</h3>

<p>コードは<code>インストールディレクトリ\config\DBConnect.groovy</code>の<code>static Closure getCreateSqlPlusConnectClosure()</code>に定義される。</p>

<ol>
<li><p>ログインするときの手続き定義</p>

<pre><code>appendAsLogon(builderName: "root") {
    talk(
            //ログイン完了した場合、テーブル一覧を取得する。
            prepareLines: "select '######' || table_name || '######' from cat where substr(table_name, 1, 2) not in ('AQ', 'QT') order by 1;"
    ) {
        //"Host name:"を受信できるまで待ち、接続先ホスト名を送信
        wait(~/Host name:/)
        send(attr.hostname)
        //"Username:"を受信できるまで待ち、認証プロキシユーザIDを送信
        wait(~/Username:/)
        send("?{AGW_UID}")
        //"Password:"を受信できるまで待ち、認証プロキシユーザパスワードを送信
        wait(~/Password:/)
        password("?{AGW_PWD}")
        //"login:"か"Username:"を受信できるまで待ち、"login:"を受信できたら、OSユーザIDを送信
        //"Username:"を受信できたら、エラーで終了する。
        wait(~/login:/) {
            error(~/Username: *$/, [error: "Audit gateway login failed with ?{AGW_UID}"])
        }
        send(attr.osUid)
        //"Password:"を受信できるまで待ち、OSユーザパスワードを送信
        wait(~/Password:/)
        send(attr.osPwd)
        //コマンドPromptを待ち、しかし、"Password:"を受けたら、エラーで終了する。
        wait(~/\]\$/) {
            error(~/^ *Password: *$/, [error: "OS login failed with aplusr01"])
        }
        //SQLPLUSを起動する。
        send("sqlplus -L ${attr.oraUid}/${attr.oraPwd}" as String)
        //コマンドPromptを待ち、着たら、ページサイズを送信する。
        wait(~/^ *SQL&gt; *$/)
        send("set pagesize 10000")
        //コマンドPromptを待ち、着たら、行サイズを送信する。
        wait(~/^ *SQL&gt; *$/)
        send("set linesize 10000")
        //コマンドPromptを待ち、着たら、項目分割文字を送信する。
        wait(~/^ *SQL&gt; *$/)
        send("set colsep '&lt;#&gt;'")
        //コマンドPromptを待ち、着たら、ログインできるとする、次は子処理（テーブル一覧取得）
        finish(~/^ *SQL&gt; *$/, [result: TalkResult.FORWARD])
        //ログイン完了後、テーブル一覧の登録処理
        regex(
                matchedResult: TalkResult.CONTINUE,
                pattern: ~/^######.*######$/,
                processor: { GraphicSqlTerminal.controller.tableNameList &lt;&lt; it[6..-9] })
        //ログイン完了後、テーブル一覧取得も終わって、コマンドPromptが出るを待ち、本手続き完了
        regex(matchedResult: TalkResult.STOP, pattern: ~/^ *SQL&gt; *$/)
    }
}
</code></pre></li>
<li><p>ログアウトするときの手続き定義</p>

<pre><code>appendAsLogoff(
        builderName: "root",
        prepareLines: ""
) {
    talk(
            unlessResult: TalkResult.STOP
    ) {
        wait(~/^ *SQL&gt; *$/)
        send("exit")
        wait(~/\$/)
        send("exit")
        send("exit")
        finish(~/Host name:/, [result: TalkResult.STOP])
    }
}
</code></pre></li>
<li><p>オラクルSelectコマンドを発行するときの結果処理<br />
<strong>※環境に応じて修正がほぼない。</strong></p>

<pre><code>appendAsSelect(builderName: "oracleSelect") {
    // タイトル処理コントロールを設定
    appendAsTitle(builderName:  "oracleTitle")
    // データ行処理コントロールを設定
    appendAsRowdata(builderName: "oracleRowdata")
    // コマンドPromptが出ると、データ全量取得完了とされる。
    regex(matchedResult: TalkResult.STOP,
            pattern: ~/^ *SQL&gt; *$/)
}
</code></pre></li>
<li><p>実行キャンセル処理
<strong>※環境に応じて修正がほぼない。</strong></p>

<pre><code>appendAsCancel(builderName: "root") {
    talk(
            unlessResult: TalkResult.STOP
    ) {
        //　Ctrl+Cを送る。
        raw(ControlCode.CTRL_C)
    }
}
</code></pre></li>
<li><p>Select以外のコマンド実行処理
<strong>※環境に応じて修正がほぼない。</strong></p>

<pre><code>appendAsExecute(builderName: "root") {
    talk {
        // コマンドPromptが出ると、実行完了とされる。
        finish(~/^ *SQL&gt; *$/, [result: TalkResult.STOP])
    }
}
</code></pre></li>
<li><p>エラー終了の場合の後方付け
<strong>※環境に応じて修正がほぼない。</strong></p>

<pre><code>appendAsReset(prepareLines: "aaa", builderName: "root") {
    talk(
            unlessResult: TalkResult.STOP
    ) {
        raw(ControlCode.CTRL_D)
        raw(ControlCode.CTRL_D)
    }
}
</code></pre></li>
</ol>

<h3>その他の設定ファイル</h3>

<p>コードは<code>インストールディレクトリ\config\Config.groovy</code>に定義される。</p>

<pre><code>GraphicSqlTerminal.controller = new ConfigBuilder().gst(
        timeoutSecond: 30000,                               //  ログインして、操作しないの自動ログアウト時間（秒）
        transTimeoutSecond: 30,                             //  SQL実行タイムアウト初期値
        proxyHost: "192.177.237.211",                       //  認証プロキシーホスト名
        proxyPort: 23,                                      //  認証プロキシーポート番号
        rawSqlEnabled: true,                                //  Select以外のSQL文発行可能か（本番の場合：false）
        fieldNameMappingPath: new File("fieldname.csv")     //  項目のSQL名称と表示名称のマッピングCSV
) {
</code></pre>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
